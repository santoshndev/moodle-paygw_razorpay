{"version":3,"file":"gateways_modal.min.js","sources":["../src/gateways_modal.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module is responsible for razorpay content in the gateways modal.\n *\n * @module     paygw_razorpay/gateway_modal\n * @copyright  2024 Santosh N.\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Repository from './repository';\nimport Templates from 'core/templates';\nimport Modal from 'core/modal';\nimport ModalEvents from 'core/modal_events';\nimport {getString} from 'core/str';\n\n\n/**\n * Creates and shows a modal that contains a placeholder.\n *\n * @returns {Promise<Modal>}\n */\nconst showModalWithPlaceholder = async() => await Modal.create({\n    body: await Templates.render('paygw_razorpay/razorpay_button_placeholder', {}),\n    show: true,\n    removeOnClose: true,\n});\n\n/**\n * Process the payment.\n *\n * @param {string} component Name of the component that the itemId belongs to\n * @param {string} paymentArea The area of the component that the itemId belongs to\n * @param {number} itemId An internal identifier that is used by the component\n * @returns {Promise<string>}\n */\nexport const process = (component, paymentArea, itemId) => {\n    return Promise.all([\n        showModalWithPlaceholder(),\n        Repository.getConfigForJs(component, paymentArea, itemId),\n    ])\n        .then(([modal, razorpayConfig]) => {\n            modal.getRoot().on(ModalEvents.hidden, () => {\n                // Destroy when hidden.\n                modal.destroy();\n            });\n\n            return Promise.all([\n                modal,\n                razorpayConfig,\n                switchSdk(),\n            ]);\n        })\n        .then(([modal, razorpayConfig]) => {\n            modal.setBody('');\n\n            return new Promise(resolve => {\n                razorpayConfig.handler = function(response) {\n                    modal.setBody(getString('authorising', 'paygw_razorpay'));\n                    // eslint-disable-next-line promise/catch-or-return,promise/no-nesting\n                    Repository.markTransactionComplete(component, paymentArea, itemId, response.razorpay_order_id,\n                        response.razorpay_payment_id, response.razorpay_signature)\n                        .then(res => {\n                            modal.hide();\n                            return res;\n                        })\n                        .then(resolve);\n                };\n                // eslint-disable-next-line no-undef\n                var rzp1 = new Razorpay(razorpayConfig);\n                rzp1.open();\n            });\n        })\n        .then(res => {\n            if (res.success) {\n                // eslint-disable-next-line promise/no-return-wrap\n                return Promise.resolve(res.message);\n            }\n\n            // eslint-disable-next-line promise/no-return-wrap\n            return Promise.reject(res.message);\n        });\n};\n\n/**\n * Unloads the previously loaded razorpay JavaScript SDK, and loads a new one.\n *\n * @returns {Promise}\n */\nconst switchSdk = () => {\n    const sdkUrl = 'https://checkout.razorpay.com/v1/checkout.js';\n\n    // Check to see if this file has already been loaded. If so just go straight to the func.\n    if (switchSdk.currentlyloaded === sdkUrl) {\n        return Promise.resolve();\n    }\n    if (switchSdk.currentlyloaded) {\n        const suspectedScript = document.querySelector(`script[src=\"${switchSdk.currentlyloaded}\"]`);\n        if (suspectedScript) {\n            suspectedScript.parentNode.removeChild(suspectedScript);\n        }\n    }\n\n    const script = document.createElement('script');\n\n    return new Promise(resolve => {\n        if (script.readyState) {\n            script.onreadystatechange = function() {\n                if (this.readyState === 'complete' || this.readyState === 'loaded') {\n                    this.onreadystatechange = null;\n                    resolve();\n                }\n            };\n        } else {\n            script.onload = function() {\n                resolve();\n            };\n        }\n\n        script.setAttribute('src', sdkUrl);\n        document.head.appendChild(script);\n\n        switchSdk.currentlyloaded = sdkUrl;\n    });\n};\n\n/**\n * Holds the full url of loaded razorpay JavaScript SDK.\n *\n * @static\n * @type {string}\n */\nswitchSdk.currentlyloaded = '';\n"],"names":["showModalWithPlaceholder","async","Modal","create","body","Templates","render","show","removeOnClose","component","paymentArea","itemId","Promise","all","Repository","getConfigForJs","then","_ref","modal","razorpayConfig","getRoot","on","ModalEvents","hidden","destroy","switchSdk","_ref2","setBody","resolve","handler","response","markTransactionComplete","razorpay_order_id","razorpay_payment_id","razorpay_signature","res","hide","Razorpay","open","success","message","reject","sdkUrl","currentlyloaded","suspectedScript","document","querySelector","parentNode","removeChild","script","createElement","readyState","onreadystatechange","this","onload","setAttribute","head","appendChild"],"mappings":";;;;;;;gKAmCMA,yBAA2BC,eAAiBC,eAAMC,OAAO,CAC3DC,WAAYC,mBAAUC,OAAO,6CAA8C,IAC3EC,MAAM,EACNC,eAAe,qBAWI,CAACC,UAAWC,YAAaC,SACrCC,QAAQC,IAAI,CACfb,2BACAc,WAAWC,eAAeN,UAAWC,YAAaC,UAEjDK,MAAKC,WAAEC,MAAOC,4BACXD,MAAME,UAAUC,GAAGC,sBAAYC,QAAQ,KAEnCL,MAAMM,aAGHZ,QAAQC,IAAI,CACfK,MACAC,eACAM,iBAGPT,MAAKU,YAAER,MAAOC,6BACXD,MAAMS,QAAQ,IAEP,IAAIf,SAAQgB,UACfT,eAAeU,QAAU,SAASC,UAC9BZ,MAAMS,SAAQ,kBAAU,cAAe,mBAEvCb,WAAWiB,wBAAwBtB,UAAWC,YAAaC,OAAQmB,SAASE,kBACxEF,SAASG,oBAAqBH,SAASI,oBACtClB,MAAKmB,MACFjB,MAAMkB,OACCD,OAEVnB,KAAKY,UAGH,IAAIS,SAASlB,gBACnBmB,aAGZtB,MAAKmB,KACEA,IAAII,QAEG3B,QAAQgB,QAAQO,IAAIK,SAIxB5B,QAAQ6B,OAAON,IAAIK,iBAShCf,UAAY,WACRiB,OAAS,kDAGXjB,UAAUkB,kBAAoBD,cACvB9B,QAAQgB,aAEfH,UAAUkB,gBAAiB,OACrBC,gBAAkBC,SAASC,oCAA6BrB,UAAUkB,uBACpEC,iBACAA,gBAAgBG,WAAWC,YAAYJ,uBAIzCK,OAASJ,SAASK,cAAc,iBAE/B,IAAItC,SAAQgB,UACXqB,OAAOE,WACPF,OAAOG,mBAAqB,WACA,aAApBC,KAAKF,YAAiD,WAApBE,KAAKF,kBAClCC,mBAAqB,KAC1BxB,YAIRqB,OAAOK,OAAS,WACZ1B,WAIRqB,OAAOM,aAAa,MAAOb,QAC3BG,SAASW,KAAKC,YAAYR,QAE1BxB,UAAUkB,gBAAkBD,WAUpCjB,UAAUkB,gBAAkB"}